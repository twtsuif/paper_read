# NeuPhysics

Editable Neural Geometry and Physics from Monocular Videos

来自单目视频的可编辑神经几何和物理



github代码：https://github.com/gaoalexander/neuphysics



## 架构图

<img src="https://cdn.jsdelivr.net/gh/twtsuif/picture/twtsuif2023-07-07/711b66143939586a12fbf1d043492465--1b21--image-20230707201859608.png" alt="image-20230707201859608" style="zoom:80%;" />

时不变场在参考系上定义

与时间相关的运动应用于空间中采样的每一个点

计算体渲染图像的颜色损失

优化神经场后嵌入可微分模拟器，来学习动力学参数并允许场景编辑



<img src="https://cdn.jsdelivr.net/gh/twtsuif/picture/twtsuif2023-07-07/119a77d7f0bb2d168cecf6d6206b85c3--63d2--image-20230707202249834.png" alt="image-20230707202249834"  />

editing pipeline

可以在六面体网格上编辑神经场

隐式表示与显式表示之间的转换

通过六面体网格编辑带符号的距离和颜色场



<img src="https://cdn.jsdelivr.net/gh/twtsuif/picture/twtsuif2023-07-07/6b6e8e5971965ad8500a3136761acaa4--dd74--image-20230707202439436.png" alt="image-20230707202439436" style="zoom:80%;" />

训练时的计算图

基本的三步动态系统中模块之间的数据传输方式

除了第一帧的六角网格重建之外，所有算子都是可微分的

在我们设计的循环一致性机制中，刚性和运动网络充当渲染和物理模块之间的桥梁



<img src="https://cdn.jsdelivr.net/gh/twtsuif/picture/twtsuif2023-07-07/a4d529b147d93f57aee27e22a700b24b--f12b--image-20230707214011159.png" alt="image-20230707214011159" style="zoom:80%;" />

实验



## Abstract

从单目RGB视频学习动态场景

为了将底层**场景几何的学习**与**动态运动**解耦，将场景表示为**时不变的SDF**，它用作**参考帧以及时间条件变形场**

设计**神经场与其相应的六面体网格**之间的双向转换，将**神经几何表示**与**可微物理模拟器**联系起来，能够通过**最小化循环一致性损失**来估计源视频中的物理参数

允许用户通过修改恢复的六面体网格，并将操作传播回神经场表示，以交互方式编辑源视频中的 3D 对象

实验表明，与竞争的神经场方法相比，可以实现出色的动态场景网格和视频重建，并且提供了大量示例，证明可从消费级相机捕获的视频中，提取有用的3D表示



## Introduction

单目RGB视频无处不在，计算机理解其内容中嵌入的空间和物理属性的能力

捕获自己移动的3D肖像，估计对象物理材料的参数并进行虚拟交互，从新角度播放现有录像，编辑卡通视频



使用神经场参数化场景的几何和动力学参数，支持后续编辑和基于物理的模拟



人类可以使用单眼轻松推断出环境的3D形状和物理属性，但这些对计算机还是很有挑战性

从单个视图进行几何重建本质上是一个欠约束问题：通常有多个 3D 结构可以导致场景的给定 2D 投影

另一个挑战是合适的建模方法

表面网格等显式表示广泛应用于计算机图形学中，但它们受到分辨率有限和拓扑固定的困扰

带符号距离函数 (SDF) 等隐式表示可以更优雅地描述复杂的几何结构，但并不直接适合推理动力学特性

估计动力学参数更具挑战性，因为它取决于正确估计几何形状及其随时间的变化



设计了一种端到端可微渲染和模拟管道

通过假设3D空间中的时间帧之间存在一对一的密集映射，我们的方法将几何估计任务解耦为两个互补的部分：静态参考帧和编码运动的映射函数。

静态参考帧由三个神经场组成：外观、刚度和几何 SDF

输入：3D坐标                输出：RGB、刚性mask、到参考系中最近表面的有符号距离

时变运动在单独的运动场中进行编码

输入：沿射线采样的3D坐标、表示特定离散时间步的学习潜码        输出：从采样坐标返回到对应参考系坐标的3D位移

我们利用 NeuS 中的密度函数进行渲染，并利用非刚性 NeRF 中的刚性mask来规范运动并获得前景/背景分离



将场景分解为**静态几何体**+**动态运动场**时出现的一个方便的属性是，通过查询运动场，我们可以建立跨帧的逐点对应关系，利用它来推断场景的动态属性

通过最小化可微模拟器和运动场的结果之间的差异来优化物理参数

可微模拟器可用于基于物理的动画和场景编辑

表面重建、视频重建、新视图合成   质量和数量都超过竞争的方法

多个示例还展示了我们完整流程的基于物理的场景理解和交互式场景编辑功能



贡献

- 直接从单个单目视频中估计和编辑几何、外观和物理参数
- 解耦静态SDF几何和动态运动，有效地规范了欠约束问题，从单目视频重建高质量的表面网格序列
- 将基于神经场的几何重建连接到可微物理引擎，消除了手动构建中间3D模型的需要，避免可微模拟器的糟糕初始化，用户可以从头开始估计建模和物理参数
- 我们在端到端建模、模拟和渲染管道中设计了显式六面体网格和隐式神经场之间的双向转换，(1) 从隐式六面体网格中提取高质量的显式网格 (2) 通过直接操作其显式网格对应物来与隐式 3D 场交互（添加、删除、移动、变形和模拟）



## Related Work

Nerf可以有效地正则化

与可微表面渲染相比，体渲染可以在整个空间中反向传播梯度，更好地优化包含拓扑变化的复杂几何体，并减轻陷入局部极小值的情况

NeRF原始密度场无法直接重建高质量表面网格，SDF场被用于多视图几何重建

与网格、点云、体素相比，SDF拥有更高的分辨率，不需要像素级分割来重建任务

当前神经SDF的方法面对动态场景时无法收敛到精确的几何形状，我们的方法可以通过单目视频实现



最近的工作已将NeRF扩展到动态场景的视频，但它们主要关注 2D 图像合成，而不是重建 3D 几何

要么直接调节时间上的神经场，要么分别学习与时间相关的运动的标准场

我们使用后者，更好地约束基于合理归纳偏差的学习问题，提供了时间步之间的逐点对应关系，动态估计很有用

使用神经SDF场表示几何，并使用强大的几何先验，比NeRF更好



可微分模拟器使物理先验更好地适应数据驱动方法，更多被用于机器人和计算机图形学任务

这些基于物理的模拟方法是针对具有不同属性的动力系统，包括刚体、软体、铰接体、布料和流体



## Method

估计相机fov内的3D几何形状、逐点对应关系、静态/动态分割

通过集成可微物理模块，我们可以从动态运动序列中学习物理参数，用于视频编辑和预测



### 渲染管线

#### SDF and color networks

与Nerf类似，基于坐标的MLP参数化场景的几何和外观，可以使用NeuS提出的体渲染方案来渲染2D图像

几何由 SDF 网络 sθSDF (p) : R3 → R 表示，将空间坐标 p ∈ R3 映射到其到最近表面的有符号距离

外观由另一个 MLP cθcolor (p) : R3 → R3 表示，它描述了每个空间点的 RGB 值

渲染过程中，从给定像素投射出的点可以写为![image-20230707203656241](https://cdn.jsdelivr.net/gh/twtsuif/picture/twtsuif2023-07-07/a39b5d407b74c5c36e748fed2774cb70--8923--image-20230707203656241.png)，o是相机中心，v是光线单位方向，t是距相机中心的距离

通过沿光线积分计算像素颜色![image-20230707203804390](https://cdn.jsdelivr.net/gh/twtsuif/picture/twtsuif2023-07-07/ef761d825c88538494c545cd7f33999d--8587--image-20230707203804390.png)

w()是权重函数，描述每个点的颜色基于其SDF值的贡献



#### Motion network

上述框架只是静态场景的多视图图像，推动了另一个组件容纳时间信息

解耦静态和动态场景组件

SDF和颜色网络在静态参考系上定义

运动网络![image-20230707204733365](https://cdn.jsdelivr.net/gh/twtsuif/picture/twtsuif2023-07-07/f53ce0fdafbd84d7aa913c1dbc1decad--668a--image-20230707204733365.png)估计每个时间步的偏移场	**I**i是学习的潜在特征，编码有关第i帧**I**i的时间信息

运动网络弯曲每个查询射线{p(t)}到{p′(t) = p(t) + b(li, p(t))}，在参考帧上查询SDF和颜色值



#### Rigidity network

分割和模拟下游场景的动态对象，使用刚性网络![image-20230707205717182](https://cdn.jsdelivr.net/gh/twtsuif/picture/twtsuif2023-07-07/a6bf9e9a2dc920fed69e3da07f4c5126--4013--image-20230707205717182.png)来区分动态前景和静态背景

参考帧上定义的掩码 r(p) ∈ [0, 1] 指示点属于场景中移动元素的扫描体积的likelihood

偏移值变为![image-20230707205916532](https://cdn.jsdelivr.net/gh/twtsuif/picture/twtsuif2023-07-07/7a86b9d1973265fa0710322791ef5a6e--9c43--image-20230707205916532.png)

该公式在训练期间将动态区域推向更大的 r(·) 值，同时将静态区域推向零



### 模拟管线

#### Geometry reconstruction

给定带符号的距离场 s(·) 和刚性掩码 r(·)，我们可以重建场景的动态和静态部分的几何形状

例如，第 i 帧中的前景包含在由下式描述的移动对象的扫描体积内

![image-20230707210250600](https://cdn.jsdelivr.net/gh/twtsuif/picture/twtsuif2023-07-07/85ced85068b36d23f340e2656ed67367--574c--image-20230707210250600.png)

其中 ksdf 和 krigidity 分别是 SDF 和刚度值的常量阈值

该公式适合转化为显示网格表示

为了渲染，我们使用marching立方体算法获得表面网格

或者我们将动态元素表示为体积网格

我们对离散 3D 网格进行采样以查找体积 Ai 内的顶点，如果网格点 p 满足方程 2，我们将该体素添加到六面体体积网格 mi 中

选择六面体而不是四面体体积网格，简单且结构规则，可以通过可微分有限元模拟器 DiffPD 进行模拟

可以在未来的工作中探索三角形表面网格和四面体体积网格



#### Physics Engine

从动态场景的输入视频中，我们可以提取具有连续运动的网格序列{mi}N i=1

单个网格模型mi，由顶点和六面体元素![image-20230714123838283](https://cdn.jsdelivr.net/gh/twtsuif/picture/twtsuif2023-07-14/5909305d8b3d4156d1c034b007fef9a0--3a20--image-20230714123838283.png)Qi的行是nv个顶点的3D坐标，Ei每行记录8个顶点的索引形成的六面体顶点

我们专注于将动态对象建模为软体

与刚体相比，软体提供了更强的表现力来建模各种可变形物体，这在基于物理的混合现实和数字孪生等应用中非常重要

作为我们的物理引擎，使用DiffPD实现的Projective Dynamics

控制方程写为

![image-20230714125004032](https://cdn.jsdelivr.net/gh/twtsuif/picture/twtsuif2023-07-14/3f4c8b331e6e7d88b239cf46dcbbafb8--19b2--image-20230714125004032.png)

其中 M 是质量矩阵，Qi 是第 i 帧处的顶点位置，h 是时间步长，̇ Qi 是速度，E 是变形引起的势能，θphysicals 是物理参数，fext 是外力。

请注意，势能 ∇E 的梯度可以解释为软材料内的内力。

该系统使用隐式时间积分来提高数值稳定性，因此 ∇E 定义在框架 i + 1 上。

物体由同质共旋转材料建模，其中材料参数 θphysicals 包括杨氏模量和泊松比



系统识别对于构建忠实的数字孪生、生成合理的动画以及动态系统的控制非常有价值

但由于系统的高维性和非线性，从单目视频，估计状态 Q 和 ̇ Q 以及参数 θphysicals 和 fext 具有挑战性

可微物理学的最新进展通过使整个模拟可微来解决这一挑战

梯度![image-20230714125725697](https://cdn.jsdelivr.net/gh/twtsuif/picture/twtsuif2023-07-14/756a94544e06da2525e2ee8b921fda90--e7db--image-20230714125725697.png)均可用，L是用户定义的标量损失函数，允许我们使用像Adam这样的基于梯度的优化器，来估计参数



#### Parameter Estimation

从第i帧开始向前运行一个模拟步骤，为我们提供了i+1帧的更新模型，取决于参数

通过在可微物理引擎 sim(θphysicals,·) 中模拟重建网格，并与作为监督信号的地面实况重建结果进行比较，我们使用基于梯度的方法优化物理参数 θphysicals

合适的损失函数的一个想法，是在提取的和模拟的网格mi+1和m′ i+1(θphysicals)之间，使用像Chamfer Distance，distance(mi+1, m′ i+1(θphysicals)) 之类的度量，搜索最小化距离θphysics

然而这种策略需要对每个时间步进行采样和网络重建，计算昂贵

此外，重建的网格可能会随着时间步长的变化而显着变化，因此不能保证逐点对应，对于网络来说动态不连续且不可微分



为节省采样时间并让梯度明确定义，我们设计了循环一致性损失来计算模拟结果和神经场之间的距离。

从第i帧的任意网格m开始，运行 j 个步骤的可微模拟，得到![image-20230714131424498](https://cdn.jsdelivr.net/gh/twtsuif/picture/twtsuif2023-07-14/a5368fe8dcd807f07929ea81ba55ca60--2004--image-20230714131424498.png)

当使用学习到的运动场将 m′ i+j(θphysicals) 变形回参考系时，结果应与原始形状 mi 相对应

由于 m′ i+j(θphysicals) 和 mi 具有共同的拓扑结构，因此存在精确的逐点对应关系，我们可以直接减去它们的点云来获得它们的距离

![image-20230714131533261](https://cdn.jsdelivr.net/gh/twtsuif/picture/twtsuif2023-07-14/e12bfec3cbc5b204ac2a8118a1eaa457--6fb3--image-20230714131533261.png)

其中 b(li, mi) 是将网格 mi 映射回参考帧的第 i 帧的运动场。 Lphysics对于运动网络、刚性网络和物理参数是可微分的。重要的是，与模拟持续时间无关，我们只需要对 mi 进行一次采样，并且它可以用作比较所有其他帧的参考点。



#### Scene Editing

管道中的模拟器强加了强大的物理先验来预测运动和修改动力学

基于从第i帧提取的六面体网格mi，我们可以对其进行模拟以获得修改状态m′ i+1。

为了渲染修改后的场景，我们在主运动场 b(li,·) 的顶部添加了一个额外的“弯曲”层 bedit(m′ i,·)



当查询射线点 p' 来渲染修改后的场景时，首先检查该点是否因我们的编辑操作而移位，即它是否位于六面体网格 m' i 内

如果 m' i 中的所有六面体都保留在规则网格中，内外测试将是繁琐的，但是，它们可能在模拟过程中变形

因此，我们将每个六面体分成五个四面体——查询点 p′ 位于六面体内部当且仅当它位于其中一个四面体内部时



根据论文[71]，我们通过p'的重心坐标来判断p'是否在四面体内部

对于由四个顶点组成的四面体{p′ i = (x′ i, y′ i, z′ i)>}4 i=1，p′ = (x′, y′, z′)> 可以计算为 ci = Deti/Det0，其中

![image-20230714133535655](https://cdn.jsdelivr.net/gh/twtsuif/picture/twtsuif2023-07-14/19391609a3c1b40f8852246de3781fcb--207f--image-20230714133535655.png)



将Det0的第i行替换为(x',y',z',1)得到Deti。当且仅当 0 ≤ ci ≤ 1 对于 i = 1, 2, 3, 4 成立时，p′ 位于该四面体的内部或表面上

为了确定四面体以检查给定点，我们使用 k 最近邻 Q′ p′ = KN N (m′ i, p′) 定位最接近查询点 p 的网格顶点 Q′ p′，并选择包含这些顶点的四面体



如果 p' 确实属于四面体，则它会与网格一起移动。

假设修改可以在四面体内部线性插值，则第i帧中的原始坐标p变为加权和p = Σ4 i=1 cipi，其中p是p′ i（编辑前）对应的参考坐标

考虑到曾经被 mi 占据但在编辑后现在为空的区域：我们只需为这些点分配一个较大的正 SDF 值，以便它们在体积渲染期间有效透明，并且不会影响 3D 重建



### 训练和损失

使用视频作为用于训练我们的系统的主要监督信号，最小化渲染图像和真值图像之间的距离![image-20230714134627184](https://cdn.jsdelivr.net/gh/twtsuif/picture/twtsuif2023-07-14/d3b2da33909ecc847c74545679603b87--76d7--image-20230714134627184.png)

我们加入了额外的项来正则化训练

SDF的一个重要属性是单位范数，Eikonal项被添加![image-20230714134753101](https://cdn.jsdelivr.net/gh/twtsuif/picture/twtsuif2023-07-14/3cf031e19b20648b75c1ba7f9c208ea9--74db--image-20230714134753101.png)

我们还想约束场景的运动(如局部刚性、不可压缩、主要包含静态区域)

因此我们包括偏移损失![image-20230714134923550](https://cdn.jsdelivr.net/gh/twtsuif/picture/twtsuif2023-07-14/eb03609cbad5118e7897b2d8ec7f719a--a2fd--image-20230714134923550.png)和散度损失![image-20230714134943594](https://cdn.jsdelivr.net/gh/twtsuif/picture/twtsuif2023-07-14/00eefbb6658aba67ed2435da3c1f5e7d--4e64--image-20230714134943594.png)

最后在训练物理参数时使用物理损失

所以总损失

![image-20230714135016366](https://cdn.jsdelivr.net/gh/twtsuif/picture/twtsuif2023-07-14/3f8107be860410cc04b8f72026dce396--751c--image-20230714135016366.png)



默认设置 wEik = 0.1、woff = 50.0 和 wdiv = 2.0

在我们提出的循环一致性物理损失中，渲染和模拟模块通过刚性和运动网络连接

并非共同训练所有参数，而是采用顺序训练策略，首先训练渲染网络来优化epoch=300000的 Ltotal，然后训练物理参数来优化epoch=100的 Lphysical

物理模块在几何网络收敛后独立训练，因为可微模拟比MLP的查询昂贵得多

在未来的工作中，尝试一种更快的模拟引擎将会很有趣，该引擎可以在渲染网络的训练过程中作为物理先验纳入其中

A5000 GPU 上，完整的训练周期通常需要大约 18 小时

对于训练数据（经同意使用），我们注意到背景必须包含足够的细节，否则 COLMAP实现的 Motion 结构可能会失败



## Experiment

### 动态几何重建

![image-20230714140136268](https://cdn.jsdelivr.net/gh/twtsuif/picture/twtsuif2023-07-14/2eea902b8a213c313bb5cb667c76dafc--97fb--image-20230714140136268.png)



### 新视图合成

我们模拟了四种可变形物体在房间内移动的情况。

我们用两个不同的相机轨迹渲染每个场景，以便一条路径可用于训练，而另一条路径可用作评估新视图合成的基本事实

![image-20230714140855393](https://cdn.jsdelivr.net/gh/twtsuif/picture/twtsuif2023-07-14/05484b57033841df78aa9c65dbc4780e--2b44--image-20230714140855393.png)

我们评估了与训练数据不同的新相机轨迹。即使在这种高度受限的任务中，我们的方法也受益于几何的一致性，并且显着优于SOTA

![image-20230714141912265](https://cdn.jsdelivr.net/gh/twtsuif/picture/twtsuif2023-07-14/c4780d5b909af8bac6d52c7c6e9e2b89--facc--image-20230714141912265.png)



### 参数估计

首先使用网络重建动态场景，使用嵌入的可微模拟器来估计物理参数，最后编辑物理参数来生成新的帧

![image-20230714142006589](https://cdn.jsdelivr.net/gh/twtsuif/picture/twtsuif2023-07-14/d7aae3a92b47956cb0c59d71ca6d44f9--cbfe--image-20230714142006589.png)

可以估计加速度和杨氏模量，生成具有不同初始速度和材料参数的新视频



### 编辑

将演示我们的混合表示如何为用户提供灵活的界面，以直接修改 3D 六面体网格上的几何形状并体积渲染结果

<img src="https://cdn.jsdelivr.net/gh/twtsuif/picture/twtsuif2023-07-14/d85170d2ed14b7741cf316f26a0a3db8--b9b2--image-20230714144032009.png" alt="image-20230714144032009" style="zoom:80%;" />



#### 感兴趣的区域

自然提供场景刚度mask和SDF值，第i帧的前景区域Ai可以使用公式计算

若需要更精确定义感兴趣区域，可自定义边界或更复杂的六面体边界体积A'

六面体网格m可以从最终感兴趣的区域A'∩Ai重建



#### 删除

通过简单地将六面体网格 m 内的查询点的 SDF 值设置为正数（例如 1.0）来删除前景

由于我们假设以 0 为中心的钟形密度分布，因此 SDF 值较大的区域不太可能被采样，因此看起来是透明的

即使背景的某些部分在原始图像中被遮挡，场景的其他视图也提供了足够的纹理/结构信息来补全缺失的背景

由于编辑完全在 3D 空间中进行，因此生成的 2D 图像清晰且真实



#### 外观

修改颜色网络的输出来改变特定区域的外观

例如，我们可能想通过降低背景的饱和度来强调视频的移动前景

通过将所有查询点的原始颜色 [r, g, b] = cθc (p) 更改为 [ r+g+b 3 , r+g+b 3 , r+g+b 3 ]



#### 重复

平移和缩放是图形设计软件中的基本操作

通过我们的管道，用户可以复制、移动和缩放六面体网格 m，从而创建新版本 m′。

在体渲染期间，m' 内点 p' 的 SDF 和颜色值设置为等于 m 中对应点 p

